#!/bin/bash

#shellcheck disable=SC2010,2154,1091

# TODO: spicetify, tmux, vim

# LOADING SHARED FILE

if [[ -f $(pwd)/shared ]]; then
    source shared
else
    echo "missing file: shared"
    exit 1
fi

# FIREFOX PLAYERCTL

install_os_utils() {
    print_title "[!] INSTALLING OS UTILITIES"
    print_info "This will install tools like "
    sudo pacman -Sy --noconfirm cmake bc rsync mlocate bash-completion git go curl wget \
                    htop neofetch zip unzip unrar p7zip lzop cpio python python-pip dnsutils rng-tools \
                    fuse fuse-exfat shellcheck jq mate-polkit man-pages man-db \
                    caja firejail dnsmasq meson ninja gtkmm3
}

# Install security tools
## TODO: hostblock, aide

install_doas() {
    print_info "'sudo' command is being replaced with 'doas'"
    yay -Sy --answerclean A --answerdiff N --noconfirm opendoas
    echo "permit persist :wheel" | sudo tee /etc/doas.conf
    echo "alias sudo=\"doas\"" >> ~/.config/zsh/alias.conf
    yay --sudo doas --sudoflags -- --save
    sudo pacman -Rs sudo
}

kernel_harden() {
    print_info "Applying hardened kernel parameters"
    cd "$1" || exit
    sudo cp sysctl.conf /etc/sysctl.d/sysctl.conf
    sudo sysctl --system
}

security_handler() {
    print_title "[!] INSTALLING SECURITY TOOLS"
    yay -Sy --answerclean A --answerdiff N --noconfirm clamav-openrc
    sudo rc-update add clamd
    sudo freshclam -d -c 1
    print_info "[!] Hardening Kernel"
    read_input_text "Want to harden kernel params?"
    if [[ $OPTION == y ]]; then
        kernel_harden $1
    fi
    print_info "[!] Installing doas"
    install_doas
}

# Install audio utilities

install_audio() {
    print_title "[!] INSTALLING AUDIO TOOLS"
    sudo pacman -Sy --noconfirm alsa-utils alsa-plugins pulseaudio pulseaudio-alsa pavucontrol
}

# Install Blutooth

install_bluetooth() {
    print_title "[!] INSTALLING BLUETOOTH"
    BLZ=$(dmesg | grep Blue | wc -l)
    if [[ $BLZ -gt 0 ]]; then
        read -p "Want to install Bluetooth? [Y/n]" -n 1 -r
        echo
        REPLY=${REPLY:-Y}
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            sudo pacman -Sy --noconfirm bluez bluez-utils pulseaudio-bluetooth
            sudo rc-update add bluetooth
        fi
    fi
}

# Install colored utilities LSD BAT

install_colored() {
    print_title "[!] INSTALLING COLORED UTILS"
    print_info "Installing LSD "
    cd /tmp || exit
    wget https://github.com/Peltoche/lsd/releases/download/0.21.0/lsd-0.21.0-x86_64-unknown-linux-gnu.tar.gz
    tar -xvf lsd-0.21.0-x86_64-unknown-linux-gnu.tar.gz
    sudo mv lsd-0.21.0-x86_64-unknown-linux-gnu /opt/lsd
    sudo ln -sn /opt/lsd/lsd /usr/local/bin/lsd
    print_info "Installing BAT"
    wget https://github.com/sharkdp/bat/releases/download/v0.19.0/bat-v0.19.0-x86_64-unknown-linux-gnu.tar.gz
    tar -xvf bat-v0.19.0-x86_64-unknown-linux-gnu.tar.gz
    sudo mv bat-v0.19.0-x86_64-unknown-linux-gnu /opt/bat
    sudo ln -sn /opt/bat/bat /usr/local/bin/bat
    print_info "Installing GRC"
    yay -Sy --noconfirm --answerclean A --answerdiff N --noconfirm grc-devel-git
}

# Install Amd GPU

install_gpu() {
    print_title "[!] INSTALLING AMD GPU"
    read_input_text "Want to install AMD GPU?"
    if [[ $OPTION == y ]]; then
        sudo pacman -Sy --noconfirm xf86-video-amdgpu mesa vulkan-radeon vulkan-tools mesa-libgl \
                                                                    vulkan-icd-loader mesa-vdpau 
        add_module "amdgpu radeon"
        if [ "$(ls /boot | grep hardened -c)" -gt "0" ]; then
            sudo mkinitcpio -p linux-hardened
        elif [ "$(ls /boot | grep lts -c)" -gt "0" ]; then
            sudo mkinitcpio -p linux-lts
        elif [ "$(ls /boot | grep zen -c)" -gt "0" ]; then
            sudo mkinitcpio -p linux-zen
        else
            sudo mkinitcpio -p linux
        fi
    fi
}

# Install Yay

install_yay() {
    print_title "[!] INSTALLING YAY"
    cd /tmp || exit
    git clone https://aur.archlinux.org/yay.git
    cd yay || exit
    makepkg -csi --noconfirm
}

install_kitty() {
    print_title "[!] INSTALLING KITTY"
    curl -L https://sw.kovidgoyal.net/kitty/installer.sh | sh /dev/stdin
    ln -s ~/.local/kitty.app/bin/kitty /usr/local/bin/
    cp ~/.local/kitty.app/share/applications/kitty.desktop ~/.local/share/applications/
    sed -i "s|Icon=kitty|Icon=/home/$USER/.local/kitty.app/share/icons/hicolor/256x256/apps/kitty.png|g" ~/.local/share/applications/kitty.desktop

}

# Installing oh-my-zsh and plugins

install_zsh_plugins() {
    print_title "[!] INSTALLING ZSH PLUGINS"
    sh -c \\"$(curl -fsSL https://raw.githubusercontent.com/robbyrussell/oh-my-zsh/master/tools/install.sh)\\"
    git clone --depth=1 https://github.com/romkatv/powerlevel10k.git "${ZSH_CUSTOM:-$HOME/.oh-my-zsh/custom}"/themes/powerlevel10k
    git clone https://github.com/zsh-users/zsh-completions "${ZSH_CUSTOM:-$HOME/.oh-my-zsh/custom}"/plugins/zsh-completions
    git clone https://github.com/zsh-users/zsh-autosuggestions "${ZSH_CUSTOM:-$HOME/.oh-my-zsh/custom}"/plugins/zsh-autosuggestions
    git clone https://github.com/zsh-users/zsh-syntax-highlighting.git "${ZSH_CUSTOM:-$HOME/.oh-my-zsh/custom}"/plugins/zsh-syntax-highlighting
}

# Configuring sddm

configure_sddm() {
    print_title "[!] CONFIGURING SDDM"
    yay -Sy --answerclean A --answerdiff N --noconfirm sddm-git
    sudo pacman -Sy qt5-graphicaleffects sddm-openrc
    cd /tmp || exit
    git clone https://github.com/RadRussianRus/sddm-slice.git
    sed -i '3 s/background=/background=~\/.images\/AbstractViolet.png/g' sddm-slice/theme.conf
    cp sddm-slice/theme.conf sdmm-slice/theme.conf.user
    sudo cp -r sddm-slice /usr/share/sddm/themes/sddm-slice
    sudo mkdir /etc/sddm.conf.d
    sudo cp /usr/lib/sddm/sddm.conf.d/default.conf /etc/sddm.conf.d/
    sudo sed -i '40 s/Current=/Current=sddm-slice/g' /etc/sddm.conf.d/default.conf
    sudo rc-update add sddm
}

# Configuring DNS 

configure_dns() {
    print_title "[!] CONFIGURING DNS"
    sudo sed -i '16 s/CONNMAN_OPTS=""/CONNMAN_OPTS="--nodnsproxy"/g' /etc/conf.d/connmand
}

# Install Virtualization

install_virtualbox() {
    print_title "[!] INSTALLING virtualbox"
    yay -Sy --noconfirm --answerclean A --answerdiff N virtualbox-bin virtualbox-ext-oracle
    sudo sed -i 's/.$//g' /etc/conf.d/modules
    sudo sed -in 's/$/ vboxdrv"/g' /etc/conf.d/modules
    sudo modprobe vboxdrv   
}

install_kvm() {
    print_title "[!] INSTALLING qemu/kvm"
    sudo pacman -Sy --noconfirm qemu libvirt virt-manager dmidecode
    sudo usermod -aG libvirt "$USER"
    sudo usermod -aG kvm "$USER"
    sudo rc-update add libvirtd
}

virtualization_handler(){
    print_title "[!] INSTALLING VIRTUALIZATION"
    read_input_text "Want to install Virtualization Software?"
    if [[ $OPTION == y ]]; then
        PS3="$prompt1"
        virt_list=("VirtualBox" "QUEMU/KVM" "NONE")
        echo -e "Select your Virtualization Software: \n"
        select VIRT in "${virt_list[@]}"; do
            if contains_element "$VIRT" "${virt_list[@]}"; then
                if [ "VirtualBox" == "$VIRT" ]; then
                    install_virtualbox
                    break
                elif [ "QUEMU/KVM" == "$VIRT" ]; then
                    install_kvm
                    break
                elif [ "NONE" == "$VIRT" ]; then
                    break
                fi
            else
                invalid_option
            fi
        done
    fi
}

# Podman Containerization

containerization_handler(){
    print_title "[!] INSTALLING CONTAINERS"
    read_input_text "Want to install Podman as Containerization Software?"
    if [[ $OPTION == y ]]; then
        sudo pacman -Sy --noconfirm crun podman       
        sudo touch /etc/{subgid,subuid}
        sudo usermod --add-subuids 165536-231072 --add-subgids 165536-231072 "$USER"
        podman system migrate
        echo "[registries.search]" | sudo tee -a /etc/containers/registries.conf
        echo "registries = ['registry.access.redhat.com', 'registry.fedoraproject.org', 'registry.centos.org', 'docker.io']" | sudo tee -a /etc/containers/registries.conf
        sudo sed -i '8 s/driver = ""/driver = "vfs"/g' /etc/containers/storage.conf
    fi
}

common_rice() {
    print_title "[!] INSTALLING COMMON RICE"
    # Nano Colors
    curl https://raw.githubusercontent.com/scopatz/nanorc/master/install.sh | sh
    # Colored Pacman
    sudo sed -i '33 s/#Color/Color/g' /etc/pacman.conf
    # Setting Theme and icon Theme
    gsettings set org.gnome.desktop.interface gtk-theme "$1"
    sudo pacman -Sy --noconfirm mpd mpv ranger feh
    gpg --keyserver keyserver.ubuntu.com --recv-key 8FD3D9A8D3800305A9FFF259D1742AD60D811D58
    yay -Sy --answerclean A --answerdiff N  papirus-icon-theme-git papirus-folders-git cava-git nerd-fonts-noto \
                                            mpc-git qutebrowser-git firefox-bin playerctl-git spotify secure-delete \
                                            tty-clock pipes.sh trash cmatrix-git gotop-git vscodium-bin
    gsettings set org.gnome.desktop.interface icon-theme 'Papirus-Dark'
    papirus-folders --theme Papirus-Dark -C violet
    sudo pip install autotiling
    # Ranger icons
    git clone https://github.com/alexanderjeurissen/ranger_devicons ~/.config/ranger/plugins/ranger_devicons
    # ZSH Plugins
    install_zsh_plugins
    # creating Directories
    cd "$HOME" || exit
    mkdir Pictures && mkdir Pictures/screenshots
}

# i3-gaps Rice

i3_rice() { # NITROGEN 
    print_title "[!] INSTALLING i3 RICE SOFTWARE"
    sudo pacman -Sy --noconfirm xorg xorg-server picom dunst i3-gaps rofi scrot xclip
    yay -Sy --answerclean A --answerdiff N --noconfirm i3lock-fancy nitrogen-git
}

compile_polybar() {
    yay -Sy --answerclean A --answerdiff N  --noconfirm polybar-git
}

i3_violet_rice() {
    yay -Sy --answerclean A --answerdiff N  --noconfirm sweet-gtk-theme-dark
    compile_polybar
    install_kitty
    common_rice "Sweet-Dark"
    cd /tmp || exit
    git clone --branch artix https://github.com/vol0s/i3-violet-rice
    cd i3-violet-rice || exit
    bash vird.sh &
}

i3_dracula_rice() {
    echo "todo"
}

# Ricing Handler

ricing_handler() {
    print_title "[!] R U RICING OR NOT"
    read_input_text "Wanna rice?"
    if [[ $OPTION == y ]]; then
        rice_list=("i3 Violet Rice" "KDE (NO RICE)" "NONE")
        PS3="$prompt1"
        echo -e "Select your rice: \n"
        select RICE in "${rice_list[@]}"; do
            if contains_element "$RICE" "${rice_list[@]}"; then
                if [ "i3 Violet Rice" == "$RICE" ]; then
                    i3_rice
                    i3_violet_rice
                    break
                elif [ "i3 Dracula Rice" == "$RICE" ]; then
                    echo "NOT FINISHED YET"
                    i3_rice
                    i3_dracula_rice
                    break
                elif [ "KDE (NO RICE)" == "$RICE" ]; then
                    sudo pacman -Sy plasma konsole ksysguard
                    break
                elif [ "NONE" == "$RICE" ]; then
                    break
                fi
            else
                invalid_option
            fi
        done
    fi
}

WS=$(pwd)
check_artixlinux
check_user
system_update
install_os_utils
configure_dns
install_yay
install_audio
install_bluetooth
install_colored
install_gpu
ricing_handler
configure_sddm
virtualization_handler
containerization_handler
security_handler "$WS"
doas rm -rf /tmp/*
doas reboot